const dropZone = document.getElementById("drop-zone");
const fileInput = document.getElementById("fileInput");
const convertBtn = document.getElementById("convertBtn");
const progress = document.getElementById("progress");
const progressText = document.getElementById("progressText");

let selectedFile = null;

dropZone.onclick = () => fileInput.click();

fileInput.onchange = () => {
  selectedFile = fileInput.files[0];
  convertBtn.disabled = !selectedFile;
};

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
  dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  selectedFile = e.dataTransfer.files[0];
  convertBtn.disabled = !selectedFile;
});

convertBtn.onclick = () => convertPDF(selectedFile);

async function convertPDF(file) {
  convertBtn.disabled = true;
  progress.value = 0;

  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  let start = Math.max(1, parseInt(startPage.value || 1));
  let end = Math.min(pdf.numPages, parseInt(endPage.value || pdf.numPages));
  if (start > end) [start, end] = [end, start];

  const total = end - start + 1;
  const zip = new JSZip();

  for (let i = start; i <= end; i++) {
    progressText.textContent = `กำลังแปลงหน้า ${i}/${end}`;

    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 2 });

    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: canvas.getContext("2d"),
      viewport
    }).promise;

    const blob = await new Promise(res =>
      canvas.toBlob(res, "image/png")
    );

    zip.file(`page-${i}.png`, blob);
    progress.value = Math.round(((i - start + 1) / total) * 100);
  }

  progressText.textContent = "กำลังสร้าง ZIP...";
  const zipBlob = await zip.generateAsync({ type: "blob" });

  download(zipBlob, `pdf-${start}-to-${end}.zip`);

  progressText.textContent = "เสร็จเรียบร้อย ✅";
  convertBtn.disabled = false;
}

function download(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
